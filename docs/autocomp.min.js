const DEFAULTS={onQuery:null,onNavigate:null,onSelect:null,onRender:null,debounce:100};export function autocomp(el,options={}){const opt={...DEFAULTS,...options};let box,cur=0,items=[],val,req;el.autocomplete="off";["input","keydown","blur","focus"].forEach(k=>el.addEventListener(k,handleEvent));function handleEvent(e){if(e.type==="keydown"&&handleKeydown(e)){return}if(e.type==="blur"){return}if(e.target.value===""){destroy();val=null;return}if(e.target.value===val){return}val=e.target.value;clearTimeout(req);req=setTimeout(query,opt.debounce)}function handleKeydown(e){if(!box){return true}switch(e.keyCode){case 38:return navigate(-1,e);case 40:return navigate(1,e);case 13:select(cur);destroy();return;case 27:destroy();return}}async function query(){if(!val){return}items=await opt.onQuery(val);if(!items.length){destroy();return}if(!box){createBox()}renderResults()}function createBox(){box=document.createElement("div");Object.assign(box.style,{width:window.getComputedStyle(el).width,position:"absolute",left:`${el.offsetLeft}px`,top:`${el.offsetTop+el.offsetHeight}px`});box.classList.add("autocomp");el.parentNode.insertBefore(box,el.nextSibling)}function renderResults(){box.innerHTML="";items.forEach((item,idx)=>{const div=document.createElement("div");div.classList.add("autocomp-item");opt.onRender?div.appendChild(opt.onRender(item)):div.innerText=item;if(idx===cur){div.classList.add("autocomp-sel")}div.addEventListener("click",()=>{select(idx);destroy()});box.appendChild(div)})}function navigate(direction,e){e.preventDefault();const prev=box.querySelector(`:nth-child(${cur+1})`);prev&&prev.classList.remove("autocomp-sel");cur=(cur+direction+items.length)%items.length;box.querySelector(`:nth-child(${cur+1})`).classList.add("autocomp-sel")}function select(idx){if(!opt.onSelect){return}val=opt.onSelect(items[idx]);el.value=val||items[idx]}function destroy(){items=[];cur=0;if(box){box.remove();box=null}}}export default autocomp;